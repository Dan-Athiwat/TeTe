<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exyrel AI 8.0 | Vision Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap');
        
        :root { --accent: #2563eb; --text-primary: #f1f5f9; }
        body { font-family: 'Kanit', sans-serif; color: var(--text-primary); margin: 0; overflow: hidden; height: 100vh; display: flex; background-color: #020617; background-size: cover; background-position: center; transition: background-image 1.5s ease-in-out; }
        #bg-overlay { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.85); z-index: -1; backdrop-filter: blur(5px); }

        /* Sidebar */
        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); z-index: 1000; width: 300px; background: rgba(15, 23, 42, 0.95); border-right: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(0); }
        #menu-btn { position: absolute; left: 24px; top: 14px; z-index: 1001; transition: left 0.4s ease; background: rgba(30, 41, 59, 0.8); padding: 8px; border-radius: 12px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; }

        .history-item { padding: 12px; margin-bottom: 8px; border-radius: 10px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; color: #cbd5e1; }
        .history-item.active { background: rgba(37, 99, 235, 0.2); border-color: #3b82f6; color: white; font-weight: 500; }

        /* Chat Layout */
        .chat-container { display: flex; flex-direction: column; gap: 1.5rem; padding: 2rem 1rem; scroll-behavior: smooth; }
        .bubble { max-width: 85%; padding: 1.25rem; border-radius: 1.5rem; font-size: 0.95rem; line-height: 1.6; position: relative; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); word-wrap: break-word; }
        .bubble-ai { align-self: flex-start; background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .bubble-user { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .bubble img { max-width: 100%; border-radius: 12px; margin-top: 8px; border: 1px solid rgba(255,255,255,0.2); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Code & Image Gen */
        .code-block { background: #000; border: 1px solid #334155; border-radius: 12px; margin-top: 10px; overflow: hidden; }
        .code-header { background: #1e293b; padding: 6px 12px; display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; }
        pre { padding: 12px; overflow-x: auto; color: #10b981; font-family: 'Fira Code', monospace; font-size: 13px; }
        .img-card { background: #000; border-radius: 1rem; overflow: hidden; margin-top: 1rem; border: 1px solid #334155; }
        .generated-image { width: 100%; height: auto; display: block; }

        /* Input & Preview */
        .input-wrapper { padding: 1.5rem; background: rgba(2, 6, 23, 0.9); border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 10px; }
        #preview-area { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; min-height: 0; transition: all 0.3s; }
        #preview-area:empty { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ */
        
        /* Preview Item Styling */
        .preview-item { position: relative; width: 60px; height: 60px; flex-shrink: 0; border-radius: 10px; overflow: hidden; border: 2px solid #3b82f6; animation: popIn 0.2s; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn { position: absolute; top: 0; right: 0; background: rgba(220, 38, 38, 0.9); color: white; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; border-bottom-left-radius: 6px; cursor: pointer; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .input-bar { max-width: 1000px; margin: 0 auto; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; display: flex; align-items: center; padding: 8px 16px; gap: 12px; width: 100%; }
        textarea { flex: 1; background: transparent; border: none; outline: none; color: white; padding: 8px 0; resize: none; max-height: 160px; }

        /* Voice Overlay */
        #voice-overlay { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .v-circle { width: 220px; height: 220px; border-radius: 50%; border: 4px solid #3b82f6; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s; }
        .v-circle.active { border-color: #10b981; box-shadow: 0 0 50px rgba(16, 185, 129, 0.5); transform: scale(1.1); }
        
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="bg-overlay"></div>

    <div id="sidebar" class="fixed inset-y-0 left-0 p-6 shadow-2xl">
        <div class="mt-12 mb-6">
            <h2 class="text-2xl font-black text-blue-500 tracking-tighter">EXYREL 8.0</h2>
            <p class="text-[10px] text-slate-400 uppercase tracking-widest">Vision Update</p>
        </div>
        <button onclick="createNewChat()" class="w-full p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold mb-4 flex items-center justify-center gap-2 transition active:scale-95"><span>+</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        <div id="hist-list" class="flex-1 overflow-y-auto space-y-1 pr-1"></div>
        <button onclick="clearAllData()" class="mt-4 text-xs text-red-400 hover:text-red-300 underline text-center w-full">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div class="flex-1 flex flex-col relative h-full">
        <div id="menu-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" fill="none" stroke="white" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </div>

        <header class="h-16 flex items-center justify-center border-b border-slate-700/50 bg-black/20 backdrop-blur-md">
            <div class="text-lg font-bold tracking-widest uppercase text-white drop-shadow-md">Exyrel AI</div>
        </header>

        <div id="chat-box" class="flex-1 overflow-y-auto chat-container"></div>

        <div class="input-wrapper">
            <div id="preview-area"></div>
            
            <div class="input-bar shadow-2xl">
                <label class="p-2 cursor-pointer text-slate-400 hover:text-white transition">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <input type="file" id="f-input" class="hidden" multiple accept="image/*" onchange="handleFile(event)">
                </label>
                <button onclick="openVoiceMode()" class="p-2 text-slate-400 hover:text-blue-400">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
                <textarea id="u-input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <button id="send-btn" onclick="handleSend()" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-500 transition active:scale-90">
                    <svg width="20" height="20" fill="none" stroke="white" stroke-width="2.5"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="voice-overlay">
        <button onclick="closeVoiceMode()" class="absolute top-10 right-10 text-white/50 hover:text-white text-lg font-bold">‚úï ‡∏õ‡∏¥‡∏î</button>
        <div class="v-circle" id="v-visual"><div class="text-white font-bold text-xl tracking-widest">EXYREL</div></div>
        <p id="v-status" class="mt-12 text-blue-400 font-medium text-lg animate-pulse">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î...</p>
        <button id="v-action-btn" class="mt-8 px-12 py-4 bg-blue-600 rounded-full font-bold shadow-lg text-white hover:bg-blue-500 transition scale-105">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î</button>
    </div>

    <script>
        // --- Memory Init ---
        let allChats = JSON.parse(localStorage.getItem('exyrel_chats')) || [];
        let currentChatId = localStorage.getItem('exyrel_current_id');
        if (allChats.length === 0) createNewChat(false);
        else if (!currentChatId) currentChatId = allChats[0].id;

        let sidebarOpen = false, filesList = [], isBusy = false;
        renderSidebar(); loadCurrentChat(); updateTheme(); setInterval(updateTheme, 1800000);

        // --- 1. Image Handling Fixed ---
        function handleFile(e) {
            const files = Array.from(e.target.files);
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ list (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10)
            if (filesList.length + files.length > 10) {
                alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }
            filesList = [...filesList, ...files];
            renderPreviews();
            e.target.value = ''; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        }

        function removeFile(index) {
            filesList.splice(index, 1); // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å array
            renderPreviews(); // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
        }

        function renderPreviews() {
            const area = document.getElementById('preview-area');
            if (filesList.length === 0) {
                area.innerHTML = '';
                return;
            }
            area.innerHTML = filesList.map((f, i) => `
                <div class="preview-item">
                    <img src="${URL.createObjectURL(f)}">
                    <div class="remove-btn" onclick="removeFile(${i})">‚úï</div>
                </div>
            `).join('');
        }

        // --- Core Chat Logic ---
        async function handleSend() {
            const input = document.getElementById('u-input');
            const text = input.value.trim();
            if ((!text && filesList.length === 0) || isBusy) return;

            isBusy = true;
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ù‡∏±‡πà‡∏á User
            addMessageToMemory('user', text, [...filesList]); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô memory (‡∏à‡∏≥‡∏•‡∏≠‡∏á URL)
            renderBubble('user', text, [...filesList]); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI
            const hasImages = filesList.length > 0;
            const imageCount = filesList.length;
            const tempFiles = [...filesList];
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ Input
            input.value = ''; input.style.height = 'auto';
            filesList = []; renderPreviews();

            // Loading state
            const tempId = 'thinking-' + Date.now();
            renderBubble('ai', '<span class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>', [], true, tempId);

            let aiResponse = "";
            
            // Logic AI Vision Simulation
            if (hasImages) {
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI ‡∏î‡∏π (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Pollinations API ‡πÄ‡∏õ‡πá‡∏ô Text-based ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö Context)
                const promptWithContext = `[System: User sent ${imageCount} images. Describe them generally as if you saw them, and answer this text: "${text}"]`;
                aiResponse = await fetchTextProcess(promptWithContext);
            } else if (/‡∏ß‡∏≤‡∏î|‡∏™‡∏£‡πâ‡∏≤‡∏á|‡∏£‡∏π‡∏õ|‡∏†‡∏≤‡∏û|üé®/i.test(text) && !text.includes('‡πÇ‡∏Ñ‡πâ‡∏î')) {
                aiResponse = await generateImageProcess(text);
            } else {
                aiResponse = await fetchTextProcess(text);
            }

            document.getElementById(tempId).remove();
            addMessageToMemory('ai', aiResponse); 
            renderBubble('ai', aiResponse);
            
            isBusy = false;
        }

        // --- Functions ---
        function renderBubble(role, content, files = [], scroll = true, id = "") {
            const div = document.createElement('div');
            if (id) div.id = id;
            div.className = `bubble ${role === 'user' ? 'bubble-user' : 'bubble-ai'}`;
            
            let html = role === 'user' ? `<b>‡∏Ñ‡∏∏‡∏ì:</b> ${content}` : `<b>AI:</b> ${formatContent(content)}`;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ô Bubble
            if (files && files.length > 0) {
                html += `<div class="grid grid-cols-2 gap-2 mt-2">`;
                files.forEach(f => {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô File object (‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà) ‡∏´‡∏£‡∏∑‡∏≠ URL string (‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å mem)
                    const src = (f instanceof File) ? URL.createObjectURL(f) : f; 
                    html += `<img src="${src}" class="rounded-lg border border-white/20">`;
                });
                html += `</div>`;
            }
            
            div.innerHTML = html;
            document.getElementById('chat-box').appendChild(div);
            if (scroll) scrollToBottom();
        }

        async function fetchTextProcess(text) {
            try {
                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(text)}?system=‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Exyrel AI ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó`);
                return await res.text();
            } catch (e) { return "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á"; }
        }

        async function generateImageProcess(prompt) {
            const clean = prompt.replace(/‡∏ß‡∏≤‡∏î|‡∏™‡∏£‡πâ‡∏≤‡∏á|‡∏£‡∏π‡∏õ|‡∏†‡∏≤‡∏û|‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢|üé®/g, '').trim();
            const url = `https://pollinations.ai/p/${encodeURIComponent(clean)}?width=1024&height=1024&seed=${Date.now()}&model=flux&nologo=true`;
            return `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ <b>"${clean}"</b> ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß:<div class="img-card"><img src="${url}" class="generated-image"></div>`;
        }

        // --- Memory & UI Utils ---
        function addMessageToMemory(role, content, files = []) {
            const chat = allChats.find(c => c.id == currentChatId);
            if (chat) {
                // ‡πÅ‡∏õ‡∏•‡∏á File Object ‡πÄ‡∏õ‡πá‡∏ô DataURL (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ save ‡∏•‡∏á localstorage ‡πÑ‡∏î‡πâ - *‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î: ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏£‡πá‡∏ß*)
                // ‡πÉ‡∏ô demo ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô dummy url ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô storage ‡πÄ‡∏ï‡πá‡∏°
                const fileUrls = files.map(f => (f instanceof File) ? "https://placehold.co/200?text=Image+Saved" : f);
                chat.messages.push({ role, content, files: fileUrls });
                if(role === 'user' && chat.messages.length <= 3) chat.title = content.substring(0,20) + "...";
                saveData(); renderSidebar();
            }
        }
        
        function formatContent(t) {
            let withLinks = t.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            if (withLinks.includes('```')) return withLinks.replace(/```(\w+)?\n([\s\S]*?)```/g, (m,l,c)=>`<div class="code-block"><div class="code-header"><span>${(l||'CODE').toUpperCase()}</span><button onclick="copy(this)">COPY</button></div><pre><code>${c.trim()}</code></pre></div>`).replace(/\n/g,'<br>');
            return withLinks.replace(/\n/g,'<br>');
        }

        function createNewChat(load=true) {
            const newChat = { id: Date.now(), title: "‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà", messages: [{role:'ai', content:'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°?'}] };
            allChats.unshift(newChat); currentChatId = newChat.id; saveData();
            if(load) { renderSidebar(); loadCurrentChat(); if(window.innerWidth<768) toggleSidebar(); }
        }
        function renderSidebar() { document.getElementById('hist-list').innerHTML = allChats.map(c => `<div onclick="switchChat(${c.id})" class="history-item ${c.id==currentChatId?'active':''}">${c.title}</div>`).join(''); }
        function switchChat(id) { currentChatId=id; saveData(); renderSidebar(); loadCurrentChat(); }
        function loadCurrentChat() { document.getElementById('chat-box').innerHTML = ''; allChats.find(c=>c.id==currentChatId)?.messages.forEach(m=>renderBubble(m.role,m.content,m.files,false)); setTimeout(scrollToBottom,100); }
        function saveData() { localStorage.setItem('exyrel_chats', JSON.stringify(allChats)); localStorage.setItem('exyrel_current_id', currentChatId); }
        function clearAllData() { if(confirm('‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { localStorage.clear(); location.reload(); } }
        function toggleSidebar() { sidebarOpen=!sidebarOpen; document.getElementById('sidebar').classList.toggle('open',sidebarOpen); document.getElementById('menu-btn').style.left=sidebarOpen?'320px':'24px'; }
        function updateTheme() { document.body.style.backgroundImage = `url('https://pollinations.ai/p/nature 8k?width=1920&height=1080&seed=${Date.now()}&model=flux')`; }
        function scrollToBottom() { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; }
        function copy(b) { navigator.clipboard.writeText(b.closest('.code-block').querySelector('code').innerText); b.innerText='COPIED'; setTimeout(()=>b.innerText='COPY',2000); }

        // --- Voice Loop Fixed ---
        const recognizer = (window.SpeechRecognition || window.webkitSpeechRecognition) ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
        if(recognizer) { recognizer.lang = 'th-TH'; recognizer.continuous = false; }
        document.getElementById('v-action-btn').onclick = () => { try{recognizer.start();}catch(e){} document.getElementById('v-visual').classList.add('active'); document.getElementById('v-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á..."; document.getElementById('v-action-btn').style.display='none'; };
        if(recognizer) {
            recognizer.onresult = async (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('v-status').innerText = `‡∏Ñ‡∏∏‡∏ì: "${text}"`;
                addMessageToMemory('user', text); renderBubble('user', text);
                document.getElementById('v-status').innerText = "Exyrel ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...";
                let aiResponse = await fetchTextProcess(text); // Voice ‡πÉ‡∏ä‡πâ Text Process ‡πÄ‡∏™‡∏°‡∏≠
                addMessageToMemory('ai', aiResponse); renderBubble('ai', aiResponse);
                speak(aiResponse);
            };
            recognizer.onend = () => { if(!window.speechSynthesis.speaking) document.getElementById('v-visual').classList.remove('active'); };
        }
        function speak(t) {
            window.speechSynthesis.cancel();
            const clean = t.replace(/```[\s\S]*?```/g, "‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö").replace(/https?:\/\/[^\s]+/g, "‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå");
            const u = new SpeechSynthesisUtterance(clean); u.lang = 'th-TH';
            u.onstart = () => { document.getElementById('v-status').innerText = "Exyrel ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î..."; document.getElementById('v-visual').classList.add('active'); };
            u.onend = () => { document.getElementById('v-status').innerText = "‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö..."; try{recognizer.start();}catch(e){} };
            window.speechSynthesis.speak(u);
        }
        function openVoiceMode() { document.getElementById('voice-overlay').style.display = 'flex'; }
        function closeVoiceMode() { document.getElementById('voice-overlay').style.display = 'none'; if(recognizer) recognizer.stop(); window.speechSynthesis.cancel(); }

        document.getElementById('send-btn').onclick = handleSend;
        document.getElementById('u-input').onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
    </script>
</body>
</html>